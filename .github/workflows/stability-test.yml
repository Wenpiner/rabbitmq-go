name: Stability Tests

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      test_type:
        description: '测试类型'
        required: true
        default: 'long-run'
        type: choice
        options:
          - long-run
          - high-concurrency
          - network-chaos
          - memory-leak
      duration:
        description: '测试时长 (例如: 1h, 30m)'
        required: false
        default: '1h'
  
  # 定期运行 (每周日凌晨)
  schedule:
    - cron: '0 0 * * 0'

jobs:
  stability-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Start infrastructure
        run: |
          docker-compose up -d rabbitmq prometheus grafana
          sleep 30
      
      - name: Wait for RabbitMQ
        run: |
          for i in {1..30}; do
            if docker-compose exec -T rabbitmq rabbitmq-diagnostics ping; then
              echo "RabbitMQ is ready"
              break
            fi
            echo "Waiting for RabbitMQ..."
            sleep 5
          done
      
      - name: Run stability test
        env:
          TEST_TYPE: ${{ github.event.inputs.test_type || 'long-run' }}
          TEST_DURATION: ${{ github.event.inputs.duration || '1h' }}
        run: |
          # 修改测试时长
          sed -i "s/TEST_DURATION: .*/TEST_DURATION: $TEST_DURATION/" docker-compose.yml
          
          # 运行测试
          ./scripts/run-stability-tests.sh $TEST_TYPE
          
          # 等待测试完成
          sleep 60
      
      - name: Collect metrics
        if: always()
        run: |
          mkdir -p test-results
          
          # 导出日志
          docker-compose logs > test-results/docker-logs.txt
          
          # 导出指标
          curl -s http://localhost:8080/metrics > test-results/app-metrics.txt || true
          
          # 导出 RabbitMQ 状态
          docker-compose exec -T rabbitmq rabbitmqctl status > test-results/rabbitmq-status.txt || true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: stability-test-results-${{ github.event.inputs.test_type || 'long-run' }}
          path: test-results/
          retention-days: 30
      
      - name: Check test results
        run: |
          # 检查是否有错误
          if docker-compose logs | grep -i "error\|fatal\|panic"; then
            echo "❌ 测试发现错误"
            exit 1
          fi
          
          echo "✅ 测试通过"
      
      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

  # 短时间快速测试 (用于 PR)
  quick-stability-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run quick stability test
        run: |
          # 启动基础设施
          docker-compose up -d rabbitmq
          sleep 20
          
          # 运行 5 分钟快速测试
          docker-compose run -e TEST_DURATION=5m stability-long-run
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v

